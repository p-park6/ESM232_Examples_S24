---
title: "Exploring Stability in Dynamic Systems"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
library(ggpubr)
```

# Fixed Harvest

What if you wanted to take the same amount of carbon each year - what would the model look like?

Think about what you would need to do to make this realistic

# Fixed Harvest Example

```{r fixed}

source("../R/dharvestfixed.R")

dharvestfixed
```

# Run the forest model

* harvest of 2kgC per year (fixed rate)
* carrying capacity of 1000kg
* growth rate of 0.05
* minimum carbon before harvest is allowed 20kg

# Run for 100 years

try it

what happens?

```{r try100}

tm = seq(from=1, to=100)
Cinitial = 30
gps = list(harv=2, K=1000, r=0.05, mincarbon=20)

res = ode(Cinitial,tm, dharvestfixed, gps)

colnames(res)=c("time","carbon")
head(res)
tail(res)
```

# Numerical Integration Issues

* particularly happens if model is "stiff" (when
system state reaches a threshold, behavior changes alot)

* our minimum carbon is a threshold

When that happens try another integration method
See *ode* help for some options

# example
```{r try2}


# notice how it fails after a certain length of time
# try another method
res = ode(Cinitial,tm, dharvestfixed, gps, method="euler")
colnames(res)=c("time","carbon")
head(res)
tail(res)

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 2kg/year\n Starting conditions 30kgC")


ggplot(as.data.frame(res), aes(time, carbon))+geom_line()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 2kg/year\n Starting conditions 30kgC")

#why this pattern
```



# Stability


Stability analysis investigates how the  system state changes, particularly focusing on where the system state 'ends up' over time and what happens when there are small perturbations to the system state

Other examples?

How would you define it?

# A broader measure of stability

* persistence 

* cycling doesn't necessarily mean unstable in an ecological sense

* define stability based on whether or not structure or function stays within expected ranges after a "press" or "pulse" disturbance

* can define metrics, similar to what we did for estimating performance or sensitivity

* multiple metrics can be useful

# Examples?

Ecological systems?

Human systems?

EJ?

# What harvest rate leads to an unstable forest?

using proportional harvest,  what rate leads to a stable forest

```{r stableforest}
source("../R/dharvest.R")
tm = seq(from=1, to=100)
Cinitial = 30
gps = list(harv=0.1, K=1000, r=0.05, mincarbon=20)
res = ode(Cinitial,tm, dharvest, gps, method="euler")
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Proportional Harvest of 10% per year \n Starting conditions 30kgC")

```



# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change..



* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
  
Stability focus..


  * *how does systems state evolution vary with inputs/parameters*


# Model versus the real world

Models can help to develop understanding, theory and hypothesis about stability by showing how different assumptions (conceptual models) impact stability

The **WHY** of stability

But the real world  is more complex - but we can learn by understanding simpler models

# Stability analysis for simple differential equations

A mathematical approach..

We can look at how the derivative (rate of change) under different system states to get a picture of when our system will be stable (e.g where small perturbations just bring the system back to a relatively constant state)


One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values

* When the derivative is 0 the system is stable

* Positive derivatives are growth

* Negative are decline

We can use derivatives to see whether and when stability will happen

# Harvest as an example

graph the derivative (how the forest carbon is changing) for different forest carbons (stock/state)

Notice where derivatives are 

* 0

* positive (growing)

* negative (declining)

Recall these are all for a proportional harvest rate of 4% per year
and a growth rate of 0.05, etc


```{r simpleapp}

tm = seq(from=1, to=100)
gps = list(harv=0.04, K=1000, r=0.05)

# create a vector of current values of carbon
Ccurr = data.frame(Ccurr=seq(from=1, to=300, by=5))
Ccurr$derv= unlist(Ccurr$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))

                                                  
ggplot(Ccurr, aes(Ccurr, derv))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) \n(kg/C/year)", x="Current Forest Carbon Stock (kgC)")

```

# what do you learn from this?

* Is there a way to get a stable forest, given
our harvest rate and growth rate?

* what size of forest would you need to *start* from


* try it


```{r try3}

# rerun our model with new initial condition that we take from the plot
tm = seq(from=1, to=100)
gps = list(harv=0.04, K=1000, r=0.05)

Cinitial=300
res = ode(Cinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")


ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Proportional Harvest of 4%year\n Starting conditions 300kgC")

```

# Using derivatives to algerbraically find stability


We can more formally find stability by finding the system state when the derivative is zero

$$	\frac{\partial C}{\partial t} = r*biomass*(1-\frac{biomass}{K})-harv*biomass$$

$$	0 = r*biomass*(1-\frac{biomass}{K})-harv*biomass $$

$$	 biomass = K*\frac{r-h}{r} $$

$$ biomass = 1000 * (0.05-0.04)/0.05 = 200 $$


try it


# Parameter and Initial Conditions Interactions 

Stability also reflects other parameters -such as harvest rate

we can also experiment with how stable harvest might change with harvest rate

try repeating above with lower and higher harvest rates


```{r stability2}

source("../R/dharvest.R")
dharvest

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate = 0.015
gps = list(harv=lowHrate, K=100, r=0.05)

# look at the derivative over a range of forest sizes

findstable = data.frame(Ccurr=seq(from=1, to=100, by=5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
                                                  
ggplot(findstable, aes(Ccurr, dervHlow))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")

# look at a different harvest rate
midHrate=0.02
gps = list(harv=midHrate, K=100, r=0.05)
findstable$dervHmid= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
 
# try high rate
highHrate=0.05
gps = list(harv=highHrate, K=100, r=0.05)
findstable$dervHhigh= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
 

# plot them all together
tmp = gather(findstable, key="HarvestRate", value="value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color=HarvestRate))+geom_point()+geom_hline(yintercept = 0, col="black")+
  labs(x="Forest Biomass (kgC)", y="Forest Growth Rate (kgC/year)")

# notice how with higher harvest rates the stable population will be lower




```

# Stability in changing systems - just looking at dervatives

Knowing the stability can help you understand the dynamics of the system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right
```{r  check}

tm = seq(from=1, to=500)
gps = list(harv=lowHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
  labs(y="Forest Biomass (kgC)", x="Year", title="low harvest rate")
  



gps = list(harv=highHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
 labs(y="Forest Biomass (kgC)", x="Year", title="High Harvest Rate")




```

# Discussion Section




What if we have a forest management task -  to make harvest a fixed amount of  carbon but only take it if forest carbon is above a threshold minimum carbon that will insure stability

Think about how you would explore stability here

* use our derivative function based on *dharvestfixed.R*

* assume a forest growth rate of 0.05, a carrying capacity of 1000kg and a harvest rate of 10kg/year

* can you figure out what the two stable values of forest carbon will be without running the ODE

# here's what I did

```{r stability}

source("../R/dharvestfixed.R")

# first lets look at how the derivative varies with the size of forest

carbon = seq(from=0, to=1000)
dcarbon= unlist(carbon %>% map(dharvestfixed,Time=NULL, parms=list(r=0.05, K=1000, mincarbon=0, harv=10)))

a =ggplot(cbind.data.frame(carbon=carbon,dcarbon=dcarbon), aes(carbon, dcarbon))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")
a 
# try it out with different initial conditions to watch how the system moves to a stable state
tm = seq(from=1, to=500)
Pinitial = 500
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

b=ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 500kgC")
ggarrange(a,b)

#  try smaller starting condition
tm = seq(from=1, to=500)
Pinitial = 150
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

c=ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")

ggarrange(b,a,c)

#  try other stable starting condition
tm = seq(from=1, to=500)

# unstable
Pinitial =275
# stable
Pinitial = 277
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")

# try a different method
res = ode(Pinitial,tm, dharvestfixed, gps, method="euler" )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")


```


# Extra Credit Assignment


1. Add a harvesting to your forest growth model from the previous assignment
You can be as simple or complex as you want (e.g you could repeat what I did above by making harvesting proportional to biomass)

2. Perform some sensitivity analysis to assess how harvesting parameters interact with forest growth parameters to influence
forest carbon at the end of the simulation time period (you can choose how long this is)

3. Write 2-3 sentences to comment on what you might learn from your sensitivity analysis


