---
title: "Homework4 Sensitivity with Sobol"
author: Patty Park
---
# Part 1
## Paragraph Recap

For my reading, I chose to read the "Exploring snow model parameter sensitivity using Sobol' variance decomposition". Here, there are two models that the paper uses are the SNOW-17 Model (a conceptual model), and the Variable Infiltration Capacity (VIC) Snow Model (a physically-based model). To properly create this model simulation, the researchers created baselines for each site per parameter. To properly evaluate the Sobol analysis, four functions were used to see the difference between the SWE and the observed time series. These researchers were able to calculate the effects by using the total toder sensitivity, which they outlined it as the sum of the first order sensitivity, the second order sensitivity and any other effects. Some of their results is finding out how the SWE model deviated well away from the VIC model. The paper attributes it to the difference in input (SWE used daily mean temp as an input while VIC used daily min and max temps as an input). This paper ends by stating that these parameter uncertainties will help improve modeling practice as well as management decisions, such as water managemnet decision, as the paper puts as an example.

# Part 2

Repeat the sensitivity analysis that we have been working on in class BUT lets assume that we are in a different locations - where windpeeds are substantially higher and more variable AND vegetation is shorter - See details below


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#load in packages
library(sensitivity)
library(tidyverse)
library(gridExtra)
library(purrr)
library(ggpubr)
library(gt)
```


Use the Sobel approach to generate parameter values for the 4 parameters
Run the atmospheric conductance model for these parameters

```{r}
source("../R/Catm.R")

# generate two examples of random number from parameter distributions

np=1000
k_o = rnorm(mean=0.1,sd=0.1*0.01, n=np)
k_d = rnorm(mean=0.7, sd=0.7*0.01, n=np)
v = rnorm(mean=300, sd=50, n=np)
height = runif(min=3.5, max=5.5, n=np)

X1 = cbind.data.frame(k_o, k_d, v, height=height)

# repeat sampling
k_o = rnorm(mean=0.1,sd=0.1*0.01, n=np)
k_d = rnorm(mean=0.7, sd=0.7*0.01, n=np)
v = rnorm(mean=300, sd=50, n=np)
height = runif(min=3.5, max=5.5, n=np)

X2 = cbind.data.frame(k_o, k_d, v, height=height)

# there are different versions of sobol functions that have different approaches for estimating parameters and indices, we use an approach implemented by jansen 

sens_Sobol_atmcon = sobolSalt(model = NULL, X1, X2, nboot = 100)

```


Get necessary parameters
```{r}
# run model for all parameter sets
# give parameters name

parms = as.data.frame(sens_Sobol_atmcon$X)
colnames(parms)= colnames(X1)
res = pmap_dbl(parms, Catm)

#tell sensitivity object about results associated with each parameter set
sens_Sobol_atmcon = sensitivity::tell(sens_Sobol_atmcon,
                                    res, 
                                    res.names="ga")

```



Plot conductance estimates in a way that accounts for parameter uncertainty

```{r}
# graph two most sensitive parameters
both = cbind.data.frame(parms, gs=sens_Sobol_atmcon$y)

# look at overall gs sensitvity to uncertainty
ggplot(both, aes(x=gs))+
  geom_histogram(col = "blue4", fill = "lightblue")+
  geom_vline(xintercept=mean(both$gs), col="red") +
  labs(y = "Count",
       x = "Conductance (mm/s)",
       title = "Parameter Uncertainty") +
  theme_minimal()

```


Plot conductance estimates against windspeed use the parameter that is 2nd in terms of total effect on response

```{r}
# look at response of conductance with the parameter that is 2nd in terms of total effect on response
ggplot(both, aes(v,gs, col=height))+
  geom_point()+
  labs(y="Conductance (mm/s)", x="Windspeed", title = "Conductance Estimate on Windspeed") +
  theme_minimal()

```

Estimate the Sobol Indices for your output

```{r}
# main effect:  partitions variance (main effect without co-variance) - sums approximately to one
# useful to add names
row.names(sens_Sobol_atmcon$S) = colnames(parms)
sens_Sobol_atmcon$S %>% gt() %>% tab_header(title = "First Order Indices")

# total effect - accounts for parameter interactions
row.names(sens_Sobol_atmcon$T) = colnames(parms)
sens_Sobol_atmcon$T %>% gt() %>% tab_header(title = "Total Order Indices")

# Both the main effect and total effect can tell us something about how the parameter influences results


```


Comment on what this tells you about how atmospheric conductance and its sensitivity to variation in windspeed differs in this setting as compared to the setting that we examined in class where windspeed was lower and less variable and vegetation was taller.

There is a broader scope of conductance and lower count overall. I conclude that there is less uncertainty from the histogram graph. There seems to be a more visible trend in the second graph that incorporates the parameter that is 2nd in terms of total effect on response. Also interesting to note is that the darker colored circled, controlled by the parameter k_d, seems to be more populated at the bottom of the cluster while the lighter colored circled, controlled by the parameter k_d, seems to be more populated at the top of the cluster.

There would be less uncertainty and more sensitivity since we have changed our parameters to look at a higher wind speed and lower height for the vegetation. I would imagine that the higher wind speed would be impacting the conductance as this is creating more friction in the atmosphere. The low height of the plant matter are keeping the plant matter together, however, which is not contributing to more friction being created.



